<blockquote><h1 id="青雀进暗杠的抽牌数期望">青雀进暗杠的抽牌数期望<a class="headerlink" href="#青雀进暗杠的抽牌数期望" title="Permanent link">&para;</a></h1>
<!-- more -->

<p>用 <a href="https://en.wikipedia.org/wiki/Markov_chain">马尔可夫链（Markov chain）</a> 暴力计算。顺便复习一下线代。</p>
<p><img alt="让我摸个鱼吧~" src="../../../obsidian-vault/attachments/qingque.jpg" /></p>
<h2 id="起因">起因<a class="headerlink" href="#起因" title="Permanent link">&para;</a></h2>
<p>看到这两个视频以后，心血来潮算的。</p>
<div class="responsive-video-container">
    <iframe src="https://player.bilibili.com/player.html?aid=1752122559&bvid=BV1vx421k77C&cid=1479621819&p=1&autoplay=0" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true"> </iframe>
</div>

<div class="responsive-video-container">
    <iframe src="https://player.bilibili.com/player.html?aid=996148265&bvid=BV16s4y1B7jm&cid=1129947597&p=1&autoplay=0" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true"> </iframe>
</div>

<p>这下真看 V 看的了。</p>
<h2 id="青雀的抽牌机制">青雀的抽牌机制<a class="headerlink" href="#青雀的抽牌机制" title="Permanent link">&para;</a></h2>
<blockquote>
<p><em>天赋</em> 帝垣琼玉</p>
<p>我方目标回合开始时，青雀会从 3 种不同花色的琼玉牌中随机抽取 1 张，最多持有 4 张琼玉牌。青雀回合开始时，若持有的琼玉牌数为 4 且花色相同，青雀消耗所有琼玉牌进入【暗杠】状态。处于【暗杠】状态时无法再次施放战技，同时使自身攻击力提高，普攻【门前清】强化为【杠上开花！】，【暗杠】状态会在施放【杠上开花！】后结束。</p>
<hr />
<p><em>战技</em> 海底捞月</p>
<p>立即抽取 2 张琼玉牌，使自身造成的伤害提高，持续至本回合结束。该效果可以叠加 4 次。施放该战技后，本回合不会结束。<sup id="fnref:1"><a class="footnote-ref" href="#fn:1">1</a></sup></p>
</blockquote>
<p>牌堆里有 3 种花色，最多同时持有 4 张牌，4 个花色相同则进暗杠。可以忽略牌的具体花色，把牌型抽象成 AABC、AABB、AAAB、AAAA 四种，AAAA 表示进入暗杠。</p>
<blockquote>
<p>青雀的摸牌是一个将琼玉牌从牌堆中取出并记录其内容，然后再将刚刚摸到的牌归还牌堆的过程，而非从牌堆中摸取琼玉牌并保留于手中的过程。根据青雀的摸牌规则（留多去少）我们又可以推导出：AAAA、AAAB、AABB、AABC是一个层级系统，后者可以向前者晋升，前者却不可向后者跌落。<sup id="fnref:2"><a class="footnote-ref" href="#fn:2">2</a></sup></p>
</blockquote>
<p>假设青雀牌堆里，各花色的牌都有无穷多张。战技抽牌流程：先抽 2 张，再去掉手里 6 张中花色数量最少的 2 张。</p>
<h2 id="马尔可夫链">马尔可夫链<a class="headerlink" href="#马尔可夫链" title="Permanent link">&para;</a></h2>
<pre class="mermaid"><code>flowchart LR
    AABC([AABC]) -- 6/9 --&gt; AAAB
    AABC -- 2/9 --&gt; AABB
    AABC -- 1/9 --&gt; AAAA

    AABB([AABB]) -- 6/9 --&gt; AAAB
    AABB --1/9 --&gt; AABB
    AABB -- 2/9 --&gt; AAAA

    AAAB([AAAB]) -- 4/9 --&gt; AAAB
    AAAB -- 5/9 --&gt; AAAA

    AAAA([AAAA]) -- 1 --&gt; AAAA</code></pre>
<p>为了避免图太乱，权为 <span class="arithmatex">\(0\)</span> 的边就不画了。可以列出下表</p>
<table>
<thead>
<tr>
<th style="text-align: center;">下次牌型\当前牌型</th>
<th style="text-align: center;">AABC</th>
<th style="text-align: center;">AABB</th>
<th style="text-align: center;">AAAB</th>
<th style="text-align: center;">AAAA</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">AABC (n+1)</td>
<td style="text-align: center;"><span class="arithmatex">\(0\)</span></td>
<td style="text-align: center;"><span class="arithmatex">\(0\)</span></td>
<td style="text-align: center;"><span class="arithmatex">\(0\)</span></td>
<td style="text-align: center;"><span class="arithmatex">\(0\)</span></td>
</tr>
<tr>
<td style="text-align: center;">AABB (n+1)</td>
<td style="text-align: center;"><span class="arithmatex">\(\dfrac{2}{9}\)</span></td>
<td style="text-align: center;"><span class="arithmatex">\(\dfrac{1}{9}\)</span></td>
<td style="text-align: center;"><span class="arithmatex">\(0\)</span></td>
<td style="text-align: center;"><span class="arithmatex">\(0\)</span></td>
</tr>
<tr>
<td style="text-align: center;">AAAB (n+1)</td>
<td style="text-align: center;"><span class="arithmatex">\(\dfrac{6}{9}\)</span></td>
<td style="text-align: center;"><span class="arithmatex">\(\dfrac{6}{9}\)</span></td>
<td style="text-align: center;"><span class="arithmatex">\(\dfrac{4}{9}\)</span></td>
<td style="text-align: center;"><span class="arithmatex">\(0\)</span></td>
</tr>
<tr>
<td style="text-align: center;">AAAA (n+1)</td>
<td style="text-align: center;"><span class="arithmatex">\(\dfrac{1}{9}\)</span></td>
<td style="text-align: center;"><span class="arithmatex">\(\dfrac{2}{9}\)</span></td>
<td style="text-align: center;"><span class="arithmatex">\(\dfrac{5}{9}\)</span></td>
<td style="text-align: center;"><span class="arithmatex">\(1\)</span></td>
</tr>
</tbody>
</table>
<p>转移矩阵</p>
<div class="arithmatex">\[
A = \begin{bmatrix}
0 &amp; 0 &amp; 0 &amp; 0\\
\dfrac{2}{9} &amp; \dfrac{1}{9} &amp; 0 &amp; 0\\
\dfrac{6}{9} &amp; \dfrac{6}{9} &amp; \dfrac{4}{9} &amp; 0\\
\dfrac{1}{9} &amp; \dfrac{2}{9} &amp; \dfrac{5}{9} &amp; 1
\end{bmatrix}
\]</div>
<p>记</p>
<ul>
<li><span class="arithmatex">\(a_n\)</span> 为第 <span class="arithmatex">\(n\)</span> 次抽牌后，牌型为 AABC 的概率 </li>
<li><span class="arithmatex">\(b_n\)</span> 为第 <span class="arithmatex">\(n\)</span> 次抽牌后，牌型为 AABB 的概率 </li>
<li><span class="arithmatex">\(c_n\)</span> 为第 <span class="arithmatex">\(n\)</span> 次抽牌后，牌型为 AAAB 的概率 </li>
<li><span class="arithmatex">\(d_n\)</span> 为第 <span class="arithmatex">\(n\)</span> 次抽牌后，牌型为 AAAA 的概率 </li>
</ul>
<p>可以得到公式</p>
<div class="arithmatex">\[
\begin{bmatrix}
a_n\\
b_n\\
c_n\\
d_n
\end{bmatrix} = A^n \begin{bmatrix}
a_0\\
b_0\\
c_0\\
d_0
\end{bmatrix}
\]</div>
<h2 id="不同牌型的抽牌数期望">不同牌型的抽牌数期望<a class="headerlink" href="#不同牌型的抽牌数期望" title="Permanent link">&para;</a></h2>
<p>先要把 <span class="arithmatex">\(A\)</span> 对角化。由</p>
<div class="arithmatex">\[
\left | \lambda E - A \right | = \begin{vmatrix}
\lambda &amp; 0 &amp; 0 &amp; 0\\
-\dfrac{2}{9} &amp; \lambda-\dfrac{1}{9} &amp; 0 &amp; 0\\
-\dfrac{6}{9} &amp; -\dfrac{6}{9} &amp; \lambda-\dfrac{4}{9} &amp; 0\\
-\dfrac{1}{9} &amp; -\dfrac{2}{9} &amp; -\dfrac{5}{9} &amp; \lambda-1
\end{vmatrix} = 0
\]</div>
<p>得</p>
<div class="arithmatex">\[
\lambda \left ( \lambda-\frac{1}{9} \right ) \left ( \lambda-\frac{4}{9} \right ) \left ( \lambda-1 \right )=0
\]</div>
<p>可求得特征值和对应的特征向量为</p>
<ul>
<li><span class="arithmatex">\(\lambda_1=0\)</span>，<span class="arithmatex">\(v_1=(2,-4,3,-1)^T\)</span>。</li>
<li><span class="arithmatex">\(\lambda_2=\dfrac{1}{9}\)</span>，<span class="arithmatex">\(v_2=(0,1,-2,1)^T\)</span>。</li>
<li><span class="arithmatex">\(\lambda_3=\dfrac{4}{9}\)</span>，<span class="arithmatex">\(v_3=(0,0,1,-1)^T\)</span>。</li>
<li><span class="arithmatex">\(\lambda_4=1\)</span>，<span class="arithmatex">\(v_4=(0,0,0,1)^T\)</span>。</li>
</ul>
<p>记</p>
<div class="arithmatex">\[
P=\begin{pmatrix}
v_1 &amp; v_2 &amp; v_3 &amp; v_4
\end{pmatrix}
\]</div>
<p>因为</p>
<div class="arithmatex">\[
\left | P \right | = \begin{vmatrix}
2 &amp; 0 &amp; 0 &amp; 0\\
-4 &amp; 1 &amp; 0 &amp; 0\\
3 &amp; -2 &amp; 1 &amp; 0\\
-1 &amp; 1 &amp; -1 &amp; 1
\end{vmatrix} = 2
\]</div>
<p>不为 <span class="arithmatex">\(0\)</span>，所以</p>
<div class="arithmatex">\[
A=P \begin{bmatrix}
0 &amp; 0 &amp; 0 &amp; 0\\
0 &amp; \dfrac{1}{9} &amp; 0 &amp; 0\\
0 &amp; 0 &amp; \dfrac{4}{9} &amp; 0\\
0 &amp; 0 &amp; 0 &amp; 1
\end{bmatrix} P^{-1}
\]</div>
<p>故</p>
<div class="arithmatex">\[
\begin{bmatrix}
a_n\\
b_n\\
c_n\\
d_n
\end{bmatrix} = P \begin{bmatrix}
0 &amp; 0 &amp; 0 &amp; 0\\
0 &amp; \left ( \dfrac{1}{9} \right )^n &amp; 0 &amp; 0\\
0 &amp; 0 &amp; \left ( \dfrac{4}{9} \right )^n &amp; 0\\
0 &amp; 0 &amp; 0 &amp; 1
\end{bmatrix} P^{-1} \begin{bmatrix}
a_0\\
b_0\\
c_0\\
d_0
\end{bmatrix}
\]</div>
<p><span class="arithmatex">\(P\)</span> 的<a href="../../../ecaa-acdj-cecf/">伴随矩阵</a></p>
<div class="arithmatex">\[
P^*=\begin{bmatrix}
1 &amp; 0 &amp; 0 &amp; 0\\
4 &amp; 2 &amp; 0 &amp; 0\\
5 &amp; 4 &amp; 2 &amp; 0\\
2 &amp; 2 &amp; 2 &amp; 2
\end{bmatrix}
\]</div>
<p><span class="arithmatex">\(P\)</span> 的逆矩阵</p>
<div class="arithmatex">\[
P^{-1}=\dfrac{1}{\left | P \right |}P^*=\begin{bmatrix}
\dfrac{1}{2} &amp; 0 &amp; 0  &amp; 0\\
2 &amp; 1 &amp; 0 &amp; 0\\
\dfrac{5}{2} &amp; 2 &amp; 1 &amp; 0\\
1 &amp; 1 &amp; 1 &amp; 1
\end{bmatrix}
\]</div>
<p>所以</p>
<div class="arithmatex">\[
\begin{bmatrix}
a_n\\
b_n\\
c_n\\
d_n
\end{bmatrix} = \begin{bmatrix}
0 &amp; 0 &amp; 0 &amp; 0\\
2\left(\dfrac{1}{9}\right)^n &amp; \left(\dfrac{1}{9}\right)^n &amp; 0 &amp; 0\\
-4\left(\dfrac{1}{9}\right)^n+\dfrac{5}{2}\left(\dfrac{4}{9}\right)^n &amp; -2\left(\dfrac{1}{9}\right)^n+2\left(\dfrac{4}{9}\right)^n &amp; \left(\dfrac{4}{9}\right)^n &amp; 0\\
2\left(\dfrac{1}{9}\right)^n-\dfrac{5}{2}\left(\dfrac{4}{9}\right)^n+1 &amp; \left(\dfrac{1}{9}\right)^n-2\left(\dfrac{4}{9}\right)^n+1 &amp; -\left(\dfrac{4}{9}\right)^n+1 &amp; 1
\end{bmatrix} \begin{bmatrix}
a_0\\
b_0\\
c_0\\
d_0
\end{bmatrix}
\]</div>
<p>上式中 <span class="arithmatex">\(n \ge 1\)</span>。抽牌数的<a href="../../../eccb-afei-ceba/">数学期望</a></p>
<div class="arithmatex">\[
EX=(d_1-d_0) + \sum_{n=2}^{\infty} n(d_n-d_{n-1})
\]</div>
<p>式中 <span class="arithmatex">\(d_0\)</span> 是参数，不可以用 <span class="arithmatex">\(d_n\)</span> 的通项计算，只能拿出来单独处理。展开后即</p>
<div class="arithmatex">\[
EX=(d_1-d_0) + \sum_{n=2}^{\infty} n\left( \dfrac{5}{9}\left(\dfrac{5}{2}a_0+2b_0+c_0\right)\left(\dfrac{4}{9}\right)^{n-1} - \dfrac{8}{9}\left(2a_0+b_0\right)\left(\dfrac{1}{9}\right)^{n-1} \right)
\]</div>
<p>令</p>
<ul>
<li><span class="arithmatex">\(k_1=\dfrac{5}{9}\left(\dfrac{5}{2}a_0+2b_0+c_0\right)\)</span></li>
<li><span class="arithmatex">\(k_2=-\dfrac{8}{9}\left(2a_0+b_0\right)\)</span></li>
<li><span class="arithmatex">\(S(q)=\displaystyle\sum\limits_{n=2}^{\infty} \left( k_1n(4q)^{n-1} + k_2nq^{n-1} \right)\)</span></li>
</ul>
<p>则</p>
<div class="arithmatex">\[
EX=(d_1-d_0) + S(\dfrac{1}{9})
\]</div>
<p>由</p>
<div class="arithmatex">\[
S(q) = \left(\sum_{n=2}^{\infty} \left( \dfrac{1}{4}k_1(4q)^n + k_2q^n \right) \right)'
\]</div>
<p>得</p>
<div class="arithmatex">\[
S(q)=\frac{8k_1q(1-2q)}{(1-4q)^2} + \frac{k_2q(2-q)}{(1-q)^2}
\]</div>
<p>进而解出</p>
<div class="arithmatex">\[
EX = \begin{bmatrix}
\dfrac{11}{4} &amp; \dfrac{99}{40} &amp; \dfrac{9}{5} &amp; 0
\end{bmatrix} \begin{bmatrix}
a_0\\
b_0\\
c_0\\
d_0
\end{bmatrix}
\]</div>
<table>
<thead>
<tr>
<th style="text-align: center;">牌型</th>
<th style="text-align: center;">抽牌数期望</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">AABC</td>
<td style="text-align: center;"><span class="arithmatex">\(\dfrac{11}{4}=2.75\)</span></td>
</tr>
<tr>
<td style="text-align: center;">AABB</td>
<td style="text-align: center;"><span class="arithmatex">\(\dfrac{99}{40}=2.475\)</span></td>
</tr>
<tr>
<td style="text-align: center;">AAAB</td>
<td style="text-align: center;"><span class="arithmatex">\(\dfrac{9}{5}=1.8\)</span></td>
</tr>
<tr>
<td style="text-align: center;">AAAA</td>
<td style="text-align: center;"><span class="arithmatex">\(0\)</span></td>
</tr>
</tbody>
</table>
<h2 id="抽牌数综合期望">抽牌数综合期望<a class="headerlink" href="#抽牌数综合期望" title="Permanent link">&para;</a></h2>
<p>起始牌型的概率分布</p>
<table>
<thead>
<tr>
<th style="text-align: center;">起始牌型</th>
<th style="text-align: center;">AABC</th>
<th style="text-align: center;">AABB</th>
<th style="text-align: center;">AAAB</th>
<th style="text-align: center;">AAAA</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><span class="arithmatex">\(P\)</span></td>
<td style="text-align: center;"><span class="arithmatex">\(\dfrac{C_4^2 \cdot 3 \cdot 2}{3^4}=\dfrac{4}{9}\)</span></td>
<td style="text-align: center;"><span class="arithmatex">\(\dfrac{C_4^2 \cdot C_3^2}{3^4}=\dfrac{2}{9}\)</span></td>
<td style="text-align: center;"><span class="arithmatex">\(\dfrac{C_4^3 \cdot 3 \cdot 2}{3^4}=\dfrac{8}{27}\)</span></td>
<td style="text-align: center;"><span class="arithmatex">\(\dfrac{3}{3^4}=\dfrac{1}{27}\)</span></td>
</tr>
</tbody>
</table>
<p>取</p>
<div class="arithmatex">\[
(a_0, b_0, c_0, d_0)^T=(\dfrac{4}{9}, \dfrac{2}{9}, \dfrac{8}{27}, \dfrac{1}{27})^T
\]</div>
<p>算得</p>
<div class="arithmatex">\[
EX = \dfrac{89}{36} \approx 2.3056
\]</div>
<h2 id="牌型分布">牌型分布<a class="headerlink" href="#牌型分布" title="Permanent link">&para;</a></h2>
<table>
<thead>
<tr>
<th style="text-align: center;">抽牌次数\牌型</th>
<th style="text-align: center;">AABC</th>
<th style="text-align: center;">AABB</th>
<th style="text-align: center;">AAAB</th>
<th style="text-align: center;">AAAA</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">0</td>
<td style="text-align: center;"><span class="arithmatex">\({\color{Red} 44.44\%}\)</span></td>
<td style="text-align: center;"><span class="arithmatex">\(22.22\%\)</span></td>
<td style="text-align: center;"><span class="arithmatex">\(29.63\%\)</span></td>
<td style="text-align: center;"><span class="arithmatex">\(3.70\%\)</span></td>
</tr>
<tr>
<td style="text-align: center;">1</td>
<td style="text-align: center;"><span class="arithmatex">\(0.00\%\)</span></td>
<td style="text-align: center;"><span class="arithmatex">\(12.35\%\)</span></td>
<td style="text-align: center;"><span class="arithmatex">\({\color{Red} 57.61\%}\)</span></td>
<td style="text-align: center;"><span class="arithmatex">\(30.04\%\)</span></td>
</tr>
<tr>
<td style="text-align: center;">2</td>
<td style="text-align: center;"><span class="arithmatex">\(0.00\%\)</span></td>
<td style="text-align: center;"><span class="arithmatex">\(1.37\%\)</span></td>
<td style="text-align: center;"><span class="arithmatex">\(33.84\%\)</span></td>
<td style="text-align: center;"><span class="arithmatex">\({\color{Red} 64.79\%}\)</span></td>
</tr>
<tr>
<td style="text-align: center;">3</td>
<td style="text-align: center;"><span class="arithmatex">\(0.00\%\)</span></td>
<td style="text-align: center;"><span class="arithmatex">\(0.15\%\)</span></td>
<td style="text-align: center;"><span class="arithmatex">\(15.95\%\)</span></td>
<td style="text-align: center;"><span class="arithmatex">\({\color{Red} 83.89\%}\)</span></td>
</tr>
<tr>
<td style="text-align: center;">4</td>
<td style="text-align: center;"><span class="arithmatex">\(0.00\%\)</span></td>
<td style="text-align: center;"><span class="arithmatex">\(0.02\%\)</span></td>
<td style="text-align: center;"><span class="arithmatex">\(7.19\%\)</span></td>
<td style="text-align: center;"><span class="arithmatex">\({\color{Red} 92.79\%}\)</span></td>
</tr>
<tr>
<td style="text-align: center;">5</td>
<td style="text-align: center;"><span class="arithmatex">\(0.00\%\)</span></td>
<td style="text-align: center;"><span class="arithmatex">\(0.00\%\)</span></td>
<td style="text-align: center;"><span class="arithmatex">\(3.21\%\)</span></td>
<td style="text-align: center;"><span class="arithmatex">\({\color{Red} 96.79\%}\)</span></td>
</tr>
<tr>
<td style="text-align: center;">6</td>
<td style="text-align: center;"><span class="arithmatex">\(0.00\%\)</span></td>
<td style="text-align: center;"><span class="arithmatex">\(0.00\%\)</span></td>
<td style="text-align: center;"><span class="arithmatex">\(1.43\%\)</span></td>
<td style="text-align: center;"><span class="arithmatex">\({\color{Red} 98.57\%}\)</span></td>
</tr>
<tr>
<td style="text-align: center;">7</td>
<td style="text-align: center;"><span class="arithmatex">\(0.00\%\)</span></td>
<td style="text-align: center;"><span class="arithmatex">\(0.00\%\)</span></td>
<td style="text-align: center;"><span class="arithmatex">\(0.63\%\)</span></td>
<td style="text-align: center;"><span class="arithmatex">\({\color{Red} 99.37\%}\)</span></td>
</tr>
</tbody>
</table>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p><a href="https://bbs.mihoyo.com/sr/wiki/content/497/detail?bbs_presentation_style=no_header">青雀-崩坏:星穹铁道WIKI-开拓者笔记-米游社</a>&#160;<a class="footnote-backref" href="#fnref:1" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
<li id="fn:2">
<p><a href="https://www.miyoushe.com/sr/article/39578076">短生种都能看懂的青雀摸牌概率【科学琼玉论】-崩坏：星穹铁道社区-米游社</a>&#160;<a class="footnote-backref" href="#fnref:2" title="Jump back to footnote 2 in the text">&#8617;</a></p>
</li>
</ol>
</div></blockquote>