<blockquote>
<p><a href="https://github.com/google/mediapipe">Mediapipe</a>作为一个可以跨平台的流视频处理库，也兼容了安卓的使用(毕竟亲爹是Google)。<br>为了在安卓里使用Mediapipe需要使用<hr /><blockquote><p><a href="https://github.com/google/mediapipe">Mediapipe</a>作为一个可以跨平台的流视频处理库，也兼容了安卓的使用(毕竟亲爹是Google)。<br>为了在安卓里使用Mediapipe需要使用bazel将mediapipe的编译为aar，来使用。</p></blockquote><h2 id="环境要求"><a href="#环境要求" class="headerlink" title="环境要求"></a><strong>环境要求</strong></h2><ol><li><strong>Linux系统</strong>(部分配置需要sh完成，为了便利，不推荐使用windows编译)</li><li><strong>bazel编译器</strong>(用于编译)</li><li><strong>adb</strong>(需不需要无所谓，是便于之后bazel打包apk后，直接install)</li><li><strong>OpenCV</strong></li><li><strong>JDK</strong></li><li><strong>python</strong></li></ol><h2 id="配置环境"><a href="#配置环境" class="headerlink" title="配置环境"></a><strong>配置环境</strong></h2><h3 id="1-配置依赖环境"><a href="#1-配置依赖环境" class="headerlink" title="(1)配置依赖环境"></a>(1)配置依赖环境</h3><p>配置依赖环境</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">sudo apt-get update &amp;&amp; sudo apt-get install -y build-essential git python zip adb openjdk-8-jdk<br></code></pre></td></tr></table></figure><blockquote><p>注意:指定python可能报错，可以自行更改为python3</p></blockquote><p>安装JDK(方便之后编译java文件):</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">sudo apt install openjdk-11-jdk<br></code></pre></td></tr></table></figure><p>安装C++编译器:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">sudo apt install g++ unzip zip<br></code></pre></td></tr></table></figure><p>安装adb:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">sudo apt-get install android-tools-adb<br></code></pre></td></tr></table></figure><p>安装OpenCV:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">sudo apt-get install libopencv-core-dev libopencv-highgui-dev \<br>libopencv-calib3d-dev libopencv-features2d-dev \<br>libopencv-imgproc-dev libopencv-video-dev<br></code></pre></td></tr></table></figure><h3 id="2-安装Bazel"><a href="#2-安装Bazel" class="headerlink" title="(2)安装Bazel"></a>(2)安装Bazel</h3><blockquote><p><a href="https://github.com/bazelbuild/bazel">Bazel</a>是一款强大的编译工具。</p></blockquote><p>对于Bazel的安装一般有两种方法：<br><strong>注意:建议下载版本为5.2.0的bazel，在mediapipe的build里指定required version为5.2.0了。</strong></p><ol><li>使用curl下载安装脚本文件</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs shell">curl -sLO --retry 5 --retry-max-time 10 \<br>https://storage.googleapis.com/bazel/5.2.0/release/bazel-5.2.0-installer-linux-x86_64.sh &amp;&amp; \<br>sudo mkdir -p /usr/local/bazel/5.2.0 &amp;&amp; \<br>chmod 755 bazel-5.2.0-installer-linux-x86_64.sh &amp;&amp; \<br>sudo ./bazel-5.2.0-installer-linux-x86_64.sh --prefix=/usr/local/bazel/5.2.0 &amp;&amp; \<br>source /usr/local/bazel/5.2.0/lib/bazel/bin/bazel-complete.bash<br><br>/usr/local/bazel/5.2.0/lib/bazel/bin/bazel version &amp;&amp; \<br>alias bazel=&#x27;/usr/local/bazel/5.2.0/lib/bazel/bin/bazel&#x27;<br></code></pre></td></tr></table></figure><ol start="2"><li>直接下载安装脚本文件并执行</li></ol><p>(1)下载<a href="https://github.com/bazelbuild/bazel/releases/download/5.2.0/bazel-5.2.0-installer-linux-x86_64.sh">bazel-5.2.0-installer-linux-x86_64.sh</a><br>(2)设置sh权限</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">sudo chmod +x bazel-5.2.0-installer-linux-x86_64.sh<br></code></pre></td></tr></table></figure><p>(3)执行sh文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">./bazel-version-installer-linux-x86_64.sh --user<br></code></pre></td></tr></table></figure><p>注意: <strong>不建议使用sudo执行，否则会安装到&#x2F;root&#x2F;bin下，影响之后的运行</strong></p><ol start="3"><li><strong>apt命令下载</strong></li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell">sudo apt install apt-transport-https curl gnupg<br>curl -fsSL https://bazel.build/bazel-release.pub.gpg | gpg --dearmor &gt;bazel-archive-keyring.gpg<br>sudo mv bazel-archive-keyring.gpg /usr/share/keyrings<br>echo &quot;deb [arch=amd64 signed-by=/usr/share/keyrings/bazel-archive-keyring.gpg] https://storage.googleapis.com/bazel-apt stable jdk1.8&quot; | sudo tee /etc/apt/sources.list.d/bazel.list<br>sudo apt update &amp;&amp; sudo apt install bazel<br>sudo apt update &amp;&amp; sudo apt full-upgrade<br>sudo apt install bazel-5.2.0<br></code></pre></td></tr></table></figure><h2 id="编译前准备"><a href="#编译前准备" class="headerlink" title="编译前准备"></a><strong>编译前准备</strong></h2><p>(1)配置bazel到PATH环境变量</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">export PATH=&quot;$PATH:bazel的安装路径/bin&quot;<br></code></pre></td></tr></table></figure><p>(2)克隆mediapipe源码并进入该目录</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">git clone https://github.com/google/mediapipe.git<br>cd mediapipe<br></code></pre></td></tr></table></figure><p>(3)测试编译环境</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">export GLOG_logtostderr=1<br><br>bazel run --define MEDIAPIPE_DISABLE_GPU=1 \<br>mediapipe/examples/desktop/hello_world:hello_world<br></code></pre></td></tr></table></figure><p>注意: <strong>编译时间可能稍长</strong></p><p>如果配置成功，则会有类似如下的打印:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs shell">I20200707 09:21:50.275205 16138 hello_world.cc:56] Hello World!<br>I20200707 09:21:50.276554 16138 hello_world.cc:56] Hello World!<br>I20200707 09:21:50.276665 16138 hello_world.cc:56] Hello World!<br>I20200707 09:21:50.276768 16138 hello_world.cc:56] Hello World!<br>I20200707 09:21:50.276887 16138 hello_world.cc:56] Hello World!<br>I20200707 09:21:50.277523 16138 hello_world.cc:56] Hello World!<br>I20200707 09:21:50.278563 16138 hello_world.cc:56] Hello World!<br>I20200707 09:21:50.279263 16138 hello_world.cc:56] Hello World!<br>I20200707 09:21:50.279850 16138 hello_world.cc:56] Hello World!<br>I20200707 09:21:50.280354 16138 hello_world.cc:56] Hello World!<br></code></pre></td></tr></table></figure><p>(4)下载安卓编译所需的SDK和NDK</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">chmod +x ./setup_android_sdk_and_ndk.sh<br>bash ./setup_android_sdk_and_ndk.sh ~/Android/Sdk ~/Android/Ndk r18b<br></code></pre></td></tr></table></figure><p><strong>建议使用r18b减少其他意外出现</strong></p><p>建议顺便设置下环境变量:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">export ANDROID_HOME=&quot;~/Android/Sdk&quot;<br>export ANDROID_NDK_HOME=&quot;~/Android/Ndk/android-ndk-r21b&quot;<br></code></pre></td></tr></table></figure><h2 id="编译所需aar包-测试hand-tracking"><a href="#编译所需aar包-测试hand-tracking" class="headerlink" title="编译所需aar包(测试hand_tracking)"></a>编译所需aar包(测试hand_tracking)</h2><p>(1)配置bazel build文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">cd mediapipe/examples/android/src/java/com/google/mediapipe/apps/<br>mkdir buid_aar &amp;&amp; cd buid_aar<br>vim BUILD<br></code></pre></td></tr></table></figure><blockquote><p>编译文件BUILD中内容如下，name是生成后aar的名字，calculators为使用的模型和计算单元，其他的模型和支持计算单元可以查看 mediapipe&#x2F;graphs&#x2F;目录下的内容，在这个目录都是Mediapipe支持的模型。其中目录 hand_tracking就是使用到的模型，支持的计算单元需要查看该目录下的BUILD文件中的 cc_library，这里我们是要部署到Android端的，所以选择Mobile的计算单元。本教程我们使用mobile_calculators，这个只检测一个手的关键点，如何想要检查多个收修改成这个计算单元multi_hand_mobile_calculators。</p></blockquote><p>之后输入:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs build">load(&quot;//mediapipe/java/com/google/mediapipe:mediapipe_aar.bzl&quot;, &quot;mediapipe_aar&quot;)<br><br>mediapipe_aar(<br>    name = &quot;mediapipe_hand_tracking&quot;,<br>    calculators = [&quot;//mediapipe/graphs/hand_tracking:mobile_calculators&quot;],<br>)<br></code></pre></td></tr></table></figure><p>(2)开始编译aar</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">chmod -R 755 mediapipe/<br><br>bazel build -c opt --fat_apk_cpu=arm64-v8a,armeabi-v7a \<br>//mediapipe/examples/android/src/java/com/google/mediapipe/apps/buid_aar:mediapipe_hand_tracking<br>bazel build -c opt mediapipe/graphs/hand_tracking:hand_tracking_mobile_gpu_binary_graph<br></code></pre></td></tr></table></figure><p>在漫长的等待后，就找到文件 bazel-bin&#x2F;mediapipe&#x2F;examples&#x2F;android&#x2F;src&#x2F;java&#x2F;com&#x2F;google&#x2F;mediapipe&#x2F;apps&#x2F;buid_aar&#x2F;mediapipe_hand_tracking.aar。</p>