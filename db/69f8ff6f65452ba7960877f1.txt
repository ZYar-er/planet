最近入手了万由的 NAS 机箱以及 J4125 板子，这里记录一下我的 All in One All in Boom 的折腾历程。注意这篇并文章非教程，只是个记录罢了。PVEPVE 是一个虚拟机...<hr />
<p>最近入手了万由的 NAS 机箱以及 J4125 板子，这里记录一下我的 All in One <del>All in Boom</del> 的折腾历程。注意这篇并文章非教程，只是个记录罢了。</p><h2 id="toc_0">PVE</h2><p>PVE 是一个虚拟机平台。</p><ol><li>下载 PVE <a href="https://www.balena.io/etcher/">https://www.balena.io/etcher/</a>。</li><li>使用 balenaEtcher 将镜像写入空 U 盘。</li></ol><p><figure><img class="" alt="image-20220918155906488" data-src="https://upload.hawa130.com/2022/09/image-20220918155906488.png#vwid=802&vhei=507" src="https://upload.hawa130.com/2022/09/image-20220918155906488.png#vwid=802&vhei=507"><figcaption>image-20220918155906488</figcaption></figure></p><ol><li>BIOS 设置 U 盘启动，一路下一步。（不过不适配 4k 显示器太折磨了）</li><li>最后自动重启，显示器上就会显示管理地址了，可以通过该地址进入管理页面，终于摆脱显示器的束缚了。</li></ol><p><figure><img class="" alt="image-20220918164504498" data-src="https://upload.hawa130.com/2022/09/image-20220918164504498.png#vwid=2880&vhei=1624" src="https://upload.hawa130.com/2022/09/image-20220918164504498.png#vwid=2880&vhei=1624"><figcaption>image-20220918164504498</figcaption></figure></p><p>这里码一下万由主板风扇控制命令。<code>i2cset -y 0 0x54 0xF0 &lt;等级&gt;</code>，等级范围为 0~255。</p><h2 id="toc_1">网卡等硬件直通</h2><ol><li><p>编辑 GRUB 配置。</p><pre><code class="lang-sh">nano /etc/default/grub</code></pre></li></ol><p><figure><img class="" alt="GRUB 配置" data-src="https://upload.hawa130.com/2022/09/image-20220918175151525.png#vwid=1242&vhei=212" src="https://upload.hawa130.com/2022/09/image-20220918175151525.png#vwid=1242&vhei=212"><figcaption>GRUB 配置</figcaption></figure></p><ol><li><p>修改 DEFAULT 行，开启 iommu。</p><pre><code>GRUB_CMDLINE_LINUX_DEFAULT=&quot;quiet intel_iommu=on&quot;</code></pre></li></ol><p><figure><img class="" alt="DEFAULT 行" data-src="https://upload.hawa130.com/2022/09/image-20220918175802436.png#vwid=926&vhei=60" src="https://upload.hawa130.com/2022/09/image-20220918175802436.png#vwid=926&vhei=60"><figcaption>DEFAULT 行</figcaption></figure></p><ol><li><p>更新 GRUB 配置。</p><pre><code class="lang-sh">update-grub</code></pre></li><li><p>加载内核模块。编辑 <code>/etc/modules</code>，添加下面的内容。</p><pre><code>vfio
vfio_iommu_type1
vfio_pci
vfio_virqfd</code></pre></li></ol><p><figure><img class="" alt="vifo 设置" data-src="https://upload.hawa130.com/2022/09/image-20220918180521513.png#vwid=562&vhei=222" src="https://upload.hawa130.com/2022/09/image-20220918180521513.png#vwid=562&vhei=222"><figcaption>vifo 设置</figcaption></figure></p><ol><li><p>更新内核模块配置。</p><pre><code class="lang-sh">update-initramfs -k all -u</code></pre></li><li><p>重启主机，之后验证直通是否开启成功。输出如下。</p><ol><li><p><code>dmesg | grep 'remapping'</code></p><pre><code>[    0.195252] DMAR-IR: Queued invalidation will be enabled to support x2apic and Intr-remapping.
[    0.197281] DMAR-IR: Enabled IRQ remapping in x2apic mode</code></pre></li><li><p><code>find /sys/kernel/iommu_groups/ -type l</code></p><pre><code>/sys/kernel/iommu_groups/7/devices/0000:00:13.3
/sys/kernel/iommu_groups/5/devices/0000:00:13.0
/sys/kernel/iommu_groups/13/devices/0000:02:00.0
/sys/kernel/iommu_groups/3/devices/0000:00:0f.0
/sys/kernel/iommu_groups/11/devices/0000:00:1f.0
/sys/kernel/iommu_groups/11/devices/0000:00:1f.1
/sys/kernel/iommu_groups/1/devices/0000:00:02.0
/sys/kernel/iommu_groups/8/devices/0000:00:14.0
/sys/kernel/iommu_groups/6/devices/0000:00:13.2
/sys/kernel/iommu_groups/14/devices/0000:03:00.0
/sys/kernel/iommu_groups/4/devices/0000:00:12.0
/sys/kernel/iommu_groups/12/devices/0000:01:00.0
/sys/kernel/iommu_groups/2/devices/0000:00:0e.0
/sys/kernel/iommu_groups/10/devices/0000:00:1c.0
/sys/kernel/iommu_groups/0/devices/0000:00:00.0
/sys/kernel/iommu_groups/9/devices/0000:00:15.0</code></pre></li></ol></li></ol><h2 id="toc_2">RTL8125B 网卡驱动</h2><p>没错，这 PVE 7 自带的网卡驱动非常寄，还是自己手动安装一个为妙。</p><p>前置准备：修改软件源为清华源。</p><ol><li><p>安装 Linux Kernel Headers</p><pre><code class="lang-shell">uname -r #-&gt; 5.13.19-2-pve，查看版本，安装对应内核版本
apt install pve-headers-5.13.19-2-pve</code></pre></li><li><p>安装 dkms</p><pre><code class="lang-shell">apt install dkms</code></pre></li><li><del>伸手党</del>下载别人编译好的驱动包 <a href="https://www.right.com.cn/FORUM/thread-7446026-1-1.html">https://www.right.com.cn/FORUM/thread-7446026-1-1.html</a>，然后 <code>dpkg -i $文件名</code> 安装即可</li><li>屏蔽自带 r8169 驱动。</li></ol><p>编辑 <code>/etc/modprobe.d/PVE-blacklist.conf</code>，插入一行 <code>blacklist r8169</code>。</p><ol><li><p>应用内核模块修改，其中 <code>-k</code> 后面的 <code>5.13.19-2-pve</code> 对应 <code>uname -r</code> 的内容，支持 Tab 补全。</p><pre><code class="lang-sh">update-initramfs -u -k 5.13.19-2-pve</code></pre></li><li>重启系统，如果想要验证的话，可以用 <code>ethtool -i &lt;网卡&gt; </code> 查看，网卡为 <code>ifconfig</code> 显示的编号，比如 <code>enp2s0</code>。</li></ol><h2 id="toc_3">iKuai</h2><ol><li>官网下载 <a href="https://www.ikuai8.com/component/download">https://www.ikuai8.com/component/download</a></li><li>上传镜像</li></ol><p><figure><img class="" alt="上传 ISO 镜像" data-src="https://upload.hawa130.com/2022/09/image-20220918171219385.png#vwid=1520&vhei=430" src="https://upload.hawa130.com/2022/09/image-20220918171219385.png#vwid=1520&vhei=430"><figcaption>上传 ISO 镜像</figcaption></figure></p><ol><li><p>创建虚拟机</p><p><figure><img class="" alt="" data-src="https://upload.hawa130.com/2022/09/image-20220918171252540.png#vwid=1482&vhei=1052" src="https://upload.hawa130.com/2022/09/image-20220918171252540.png#vwid=1482&vhei=1052"></figure></p><ol><li><p>分配硬盘</p><ul><li>官方建议配置是 &gt; 1GB，我分配 4GB 算是绰绰有余了。</li></ul></li></ol><p><figure><img class="" alt="硬盘分配" data-src="https://upload.hawa130.com/2022/09/image-20220918172146458.png#vwid=1424&vhei=552" src="https://upload.hawa130.com/2022/09/image-20220918172146458.png#vwid=1424&vhei=552"><figcaption>硬盘分配</figcaption></figure></p><ol><li><p>分配 CPU</p><ul><li>不够了以后再调整，先分配个双核。</li></ul></li><li><p>分配内存</p><ul><li>官方建议内存 &gt; 4GB，不过听说实际用不到这么多，先按最低标准分配 4GB 吧。</li></ul><p><figure><img class="" alt="内存分配" data-src="https://upload.hawa130.com/2022/09/image-20220918172511835.png#vwid=866&vhei=168" src="https://upload.hawa130.com/2022/09/image-20220918172511835.png#vwid=866&vhei=168"><figcaption>内存分配</figcaption></figure></p></li><li><p>配置网络</p><ul><li>作为拨号用的主系统，需要直通一个网卡，不然会卡卡卡卡死，所以安装好后需要进行 PCI 设备直通。</li></ul></li><li>添加 PCI 设备——网卡，勾选「所有功能」。（02:00.0 一般是管理口，直通的话，PVE 管理界面就进不去了，不要问我怎么知道的）</p><p><figure><img class="" alt="直通网卡" data-src="https://upload.hawa130.com/2022/09/image-20220918190825780.png#vwid=1390&vhei=498" src="https://upload.hawa130.com/2022/09/image-20220918190825780.png#vwid=1390&vhei=498"><figcaption>直通网卡</figcaption></figure></li></ol></li><li>启动虚拟机安装 iKuai 吧。</p><p><figure><img class="" alt="iKuai" data-src="https://upload.hawa130.com/2022/09/image-20220918191113236.png#vwid=5118&vhei=2178" src="https://upload.hawa130.com/2022/09/image-20220918191113236.png#vwid=5118&vhei=2178"><figcaption>iKuai</figcaption></figure></li><li>iKuai 安装好之后，记得启动 DHCP 服务器。「网络设置」→「DHCP 设置」→「DHCP 服务端」，添加 DHCP 地址池并启用即可。</li></ol><h2 id="toc_4">OpenWrt</h2><ol><li>新建一个空虚拟机，操作系统不使用任何介质，系统机型选择 Q35，其他的按需分配，注意硬盘过会也要删掉，所以随意设置大小吧。</li><li>硬件菜单，选择硬盘，分离并删除（把虚拟硬盘扬了。</li><li>把 OpenWrt 镜像上传到 PVE。通过 <code>scp</code> 传输比较方便，FTP 也可以。</li><li>将镜像导入到虚拟机中。<code>qm importdisk &lt;虚拟机ID&gt; &lt;镜像文件&gt; local-lvm</code>，导入后 Web 界面就能看到这个「未使用的磁盘」了。</li><li>双击，添加这个「未使用的磁盘」。</li><li>选项里面，修改「引导顺序」，把刚才添加的硬盘挪到第一位，接下来启动虚拟机吧。</li><li>可以编辑 <code>/etc/config/network</code> 修改 OpenWrt 的 IP 地址，通过该地址访问管理界面。</li></ol><p>既然装好了 OpenWrt 就随便折腾吧，注意需要设置 LAN 接口的网关为 iKuai 的 IP 地址，并关闭 DHCP 分配（忽略此接口）。</p><h2 id="toc_5">黑群晖</h2><p>压轴大戏！需要直通核显和硬盘，还是比较麻烦的。</p><h3 id="toc_6">核显直通</h3><p>以上面的硬件直通已经做了为前提。</p><ol><li><p>依然是编辑 GRUB 配置的那行。<code>nano /etc/default/grub</code>，编辑完成后更新引导 <code>update-grub</code>。</p><pre><code>GRUB_CMDLINE_LINUX_DEFAULT=&quot;quiet intel_iommu=on iommu=pt video=efifb:off&quot;</code></pre></li><li><p>查看核显的硬件 ID。<code>lspci -nn</code></p><pre><code>00:02.0 VGA compatible controller [0300]: Intel Corporation GeminiLake [UHD Graphics 600] [8086:3185] (rev 06)</code></pre></li></ol><p>即 <code>8086:3185</code>。</p><ol><li><p>添加 vifo 配置。<code>nano /etc/modprobe.d/vfio.conf</code></p><pre><code>options vfio-pci ids=8086:3185</code></pre></li><li><p>屏蔽驱动。<code>nano /etc/modprobe.d/blacklist.conf</code></p><pre><code>blacklist snd_hda_intel
blacklist snd_hda_codec_hdmi
blacklist i915</code></pre></li><li>更新配置。<code>update-initramfs -u</code></li><li>重启 PVE 系统。</li></ol><h3 id="toc_7">创建虚拟机</h3><p><strong>前提</strong>：BIOS 的 CSM 设置 enable，video 设置为 Legacy。</p><p>创建一个空虚拟机，注意，<strong>处理器类别选择「host」</strong>。其他保持默认或按需选择即可。</p><p>由于黑群有各种各样不同的体质，完全按照此步骤来安装不成功也是正常现象。</p><p>黑群的关键在于引导，DSM 系统可以用原厂的，从群晖官网下载即可，注意引导要支持这个版本的系统才行。有核显的机器建议选择 DS918+ 的系统。</p><p><a href="https://wp.gxnas.com/11849.html">黑群引导索引</a>（来自 GXNAS）</p><h3 id="toc_8">虚拟机直通</h3><h4 id="toc_9">核显直通</h4><p>在 Web 界面添加 PCI 设备核显。</p><p><figure><img class="" alt="核显直通" data-src="https://upload.hawa130.com/2022/09/image-20220924180422650.png#vwid=1092&vhei=184" src="https://upload.hawa130.com/2022/09/image-20220924180422650.png#vwid=1092&vhei=184"><figcaption>核显直通</figcaption></figure></p><h4 id="toc_10">SATA 控制器直通</h4><p>在 Web 端添加 SATA 控制器 PCI 设备即可。</p><p><figure><img class="" alt="SATA 控制器直通" data-src="https://upload.hawa130.com/2022/09/image-20220924180028844.png#vwid=1450&vhei=354" src="https://upload.hawa130.com/2022/09/image-20220924180028844.png#vwid=1450&vhei=354"><figcaption>SATA 控制器直通</figcaption></figure></p><h3 id="toc_11">导入引导硬盘</h3><p>将引导镜像上传到 PVE 虚拟机上，执行命令导入虚拟硬盘，然后双击添加，注意选择 SATA 格式。</p><pre><code>qm importdisk &lt;虚拟机ID&gt; &lt;引导镜像文件路径&gt; local-lvm</code></pre><p>在选项里面设置这个硬盘为第一启动项。导入完成后就能愉快地启动系统了，启动时选择 SATA 那一项（默认是 USB）。</p><p>如果不出意外的话，访问虚拟机的 IP 地址（如果不知道的话，可以去 iKuai 的 DHCP 客户端看看）的 5000 端口就可以进入安装界面了。</p>
